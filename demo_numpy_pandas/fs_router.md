##### 1. 关于hash, 和输入顺序无关，只取决于输入和hash函数

key ---> hash ---> hash-value
--------------------------------------------------------------
key                  hash-key               value
d-0x.winudf.com -->  %s-%s.format(i, key)   hash(hash-key)
hash 的值与输入顺序无关，只和进行hash的输入有关.
--------------------------------------------------------------

##### 2.均衡算法的具体实现
```go
func (c *Consistent) Add(host string) {
    c.Lock()
    defer c.Unlock()

    if _, ok := c.loadMap[host]; ok {
        return
    }

    c.loadMap[host] = &Host{Name: host, Load: 0}
    for i := 0; i < replicationFactor; i++ {
        h := c.hash(fmt.Sprintf("%s%d", host, i))
        c.hosts[h] = host
        c.sortedSet = append(c.sortedSet, h)

    }
    // sort hashes ascendingly
    sort.Slice(c.sortedSet, func(i int, j int) bool {
        if c.sortedSet[i] < c.sortedSet[j] {
            return true
        }
        return false
    })
    c.print()
}

func (c *Consistent) hash(key string) uint64 {
    out := blake2b.Sum512([]byte(key))
    return binary.LittleEndian.Uint64(out[:])
}

// Returns the maximum load of the single host
// which is:
// (total_load/number_of_hosts)*1.25
// total_load = is the total number of active requests served by hosts
// for more info:
// https://research.googleblog.com/2017/04/consistent-hashing-with-bounded-loads.html
func (c *Consistent) MaxLoad() int64 {
    if c.totalLoad == 0 {
        c.totalLoad = 1
    }
    var avgLoadPerNode float64
    avgLoadPerNode = float64(c.totalLoad / int64(len(c.loadMap)))
    if avgLoadPerNode == 0 {
        avgLoadPerNode = 1
    }
    avgLoadPerNode = math.Ceil(avgLoadPerNode * 1.25)
    return int64(avgLoadPerNode)
}

func (c *Consistent) print() {
    b, err := json.Marshal(c.sortedSet)
    if err != nil {
        fmt.Errorf("err:%v", err)
    }
    fmt.Println(string(b))
}

// It uses Consistent Hashing With Bounded loads
//
// https://research.googleblog.com/2017/04/consistent-hashing-with-bounded-loads.html
//
// to pick the least loaded host that can serve the key
//
// It returns ErrNoHosts if the ring has no hosts in it.
//
func (c *Consistent) GetLeast(key string) (string, error) {
    c.RLock()
    defer c.RUnlock()

    if len(c.hosts) == 0 {
        return "", ErrNoHosts
    }

    h := c.hash(key)
    idx := c.search(h) //根据一致性计算,获取host
    fmt.Println("hash:%v idx:%v", h, idx)

    i := idx
    for {
        host := c.hosts[c.sortedSet[i]]
        fmt.Println("host:", host, "i:", i)
        c.print()
        if c.loadOK(host) { //判断是否已经负载达到Maxload, 如果已经达到，分配给下一个, 循环选取
            return host, nil
        }
        i++
        if i >= len(c.hosts) {
            i = 0
        }
    }
}
```



##### 3.一致性均衡hash 的测试效果
consistance-balance:
GetLoads: {
    d-01.winudf.com: 1,  #2, 一致性
    d-02.winudf.com: 0,  #2, 均衡
    d-03.winudf.com: 0,  #2, 均衡
    d-04.winudf.com: 0,  #2, 均衡
    d-05.winudf.com: 0,  #1次后，c.totalLoad + 1 刚好达到平均负载，maxLoad++， 重新回归一致性.
},
MaxLoad: 2

--------------------------------------------------------------
```bash
2018/01/08 14:29:55 [D] [hashhost.go:181] host:d-02.winudf.com err:<nil>
2018/01/08 14:30:06 [D] [host_grpc.go:41] req-len:1
hash:%v idx:%v 995549524595603026 3
host: d-01.winudf.com i: 3
[239767381301946287,452996756677201714,784583097262749752,2977716204983640882,3502165566924052056,3983909878270734083,4218835131624438454,4451133326594493219,4904457498958676496,5193981502517103491,6666967547630157160,7692414431255807895,7916375373558770949,8234608672636041183,8897651215659834605,9628520333863316297,10390044413896638947,10430329369657078618,10458146926787108284,10707663742784821561,11288839448486286693,11348286291119357192,11540013013605019730,11568738635287076629,12002990505820781658,12169615549004988701,12454832026850195165,13184936874599904655,13371020549017399961,14336560970540577641,14344554222429636802,14469340804132123322,15325594361307077113,16317840089229516113,16549567120859172415,17365357814277938146,17481834308909352631,17720137207200896767,18280333195893202206,18335112364259407429]
avgLoadPerNode: 1 c.totalLoad + 1: 4 loadMap: 4
*1.25: 2
host: d-02.winudf.com i: 4
[239767381301946287,452996756677201714,784583097262749752,2977716204983640882,3502165566924052056,3983909878270734083,4218835131624438454,4451133326594493219,4904457498958676496,5193981502517103491,6666967547630157160,7692414431255807895,7916375373558770949,8234608672636041183,8897651215659834605,9628520333863316297,10390044413896638947,10430329369657078618,10458146926787108284,10707663742784821561,11288839448486286693,11348286291119357192,11540013013605019730,11568738635287076629,12002990505820781658,12169615549004988701,12454832026850195165,13184936874599904655,13371020549017399961,14336560970540577641,14344554222429636802,14469340804132123322,15325594361307077113,16317840089229516113,16549567120859172415,17365357814277938146,17481834308909352631,17720137207200896767,18280333195893202206,18335112364259407429]
avgLoadPerNode: 1 c.totalLoad + 1: 4 loadMap: 4
*1.25: 2
2018/01/08 14:30:06 [D] [hashhost.go:181] host:d-02.winudf.com err:<nil>
2018/01/08 14:30:12 [D] [host_grpc.go:41] req-len:1
hash:%v idx:%v 995549524595603026 3
host: d-01.winudf.com i: 3
[239767381301946287,452996756677201714,784583097262749752,2977716204983640882,3502165566924052056,3983909878270734083,4218835131624438454,4451133326594493219,4904457498958676496,5193981502517103491,6666967547630157160,7692414431255807895,7916375373558770949,8234608672636041183,8897651215659834605,9628520333863316297,10390044413896638947,10430329369657078618,10458146926787108284,10707663742784821561,11288839448486286693,11348286291119357192,11540013013605019730,11568738635287076629,12002990505820781658,12169615549004988701,12454832026850195165,13184936874599904655,13371020549017399961,14336560970540577641,14344554222429636802,14469340804132123322,15325594361307077113,16317840089229516113,16549567120859172415,17365357814277938146,17481834308909352631,17720137207200896767,18280333195893202206,18335112364259407429]
avgLoadPerNode: 1 c.totalLoad + 1: 5 loadMap: 4
*1.25: 2
host: d-02.winudf.com i: 4
[239767381301946287,452996756677201714,784583097262749752,2977716204983640882,3502165566924052056,3983909878270734083,4218835131624438454,4451133326594493219,4904457498958676496,5193981502517103491,6666967547630157160,7692414431255807895,7916375373558770949,8234608672636041183,8897651215659834605,9628520333863316297,10390044413896638947,10430329369657078618,10458146926787108284,10707663742784821561,11288839448486286693,11348286291119357192,11540013013605019730,11568738635287076629,12002990505820781658,12169615549004988701,12454832026850195165,13184936874599904655,13371020549017399961,14336560970540577641,14344554222429636802,14469340804132123322,15325594361307077113,16317840089229516113,16549567120859172415,17365357814277938146,17481834308909352631,17720137207200896767,18280333195893202206,18335112364259407429]
avgLoadPerNode: 1 c.totalLoad + 1: 5 loadMap: 4
*1.25: 2
host: d-03.winudf.com i: 5
[239767381301946287,452996756677201714,784583097262749752,2977716204983640882,3502165566924052056,3983909878270734083,4218835131624438454,4451133326594493219,4904457498958676496,5193981502517103491,6666967547630157160,7692414431255807895,7916375373558770949,8234608672636041183,8897651215659834605,9628520333863316297,10390044413896638947,10430329369657078618,10458146926787108284,10707663742784821561,11288839448486286693,11348286291119357192,11540013013605019730,11568738635287076629,12002990505820781658,12169615549004988701,12454832026850195165,13184936874599904655,13371020549017399961,14336560970540577641,14344554222429636802,14469340804132123322,15325594361307077113,16317840089229516113,16549567120859172415,17365357814277938146,17481834308909352631,17720137207200896767,18280333195893202206,18335112364259407429]
avgLoadPerNode: 1 c.totalLoad + 1: 5 loadMap: 4
*1.25: 2
```


--------------------------------------------------------------
c.sorted
```bash
          host_name                  hash                 diff
0   d-03.winudf.com    239767381301946287   239767381301946287
1   d-02.winudf.com    452996756677201714   213229375375255427
2   d-01.winudf.com    784583097262749752   331586340585548038
3   d-01.winudf.com   2977716204983640882  2193133107720891130
4   d-05.winudf.com   3056735848870237707    79019643886596825
5   d-02.winudf.com   3502165566924052056   445429718053814349
6   d-05.winudf.com   3696353760717863724   194188193793811668
7   d-03.winudf.com   3983909878270734083   287556117552870359
8   d-01.winudf.com   4218835131624438454   234925253353704371
9   d-04.winudf.com   4451133326594493219   232298194970054765
10  d-04.winudf.com   4904457498958676496   453324172364183277
11  d-05.winudf.com   5070389339984637017   165931841025960521
12  d-04.winudf.com   5193981502517103491   123592162532466474
13  d-05.winudf.com   5528192315630124532   334210813113021041
14  d-01.winudf.com   6666967547630157160  1138775232000032628
15  d-01.winudf.com   7692414431255807895  1025446883625650735
16  d-02.winudf.com   7916375373558770949   223960942302963054
17  d-01.winudf.com   8234608672636041183   318233299077270234
18  d-02.winudf.com   8897651215659834605   663042543023793422
19  d-03.winudf.com   9628520333863316297   730869118203481692
20  d-05.winudf.com  10092989078352289744   464468744488973447
21  d-04.winudf.com  10390044413896638947   297055335544349203
22  d-03.winudf.com  10430329369657078618    40284955760439671
23  d-01.winudf.com  10458146926787108284    27817557130029666
24  d-04.winudf.com  10707663742784821561   249516815997713277
25  d-05.winudf.com  10750911147294077240    43247404509255679
26  d-01.winudf.com  11288839448486286693   537928301192209453
27  d-02.winudf.com  11348286291119357192    59446842633070499
28  d-03.winudf.com  11540013013605019730   191726722485662538
29  d-04.winudf.com  11568738635287076629    28725621682056899
30  d-01.winudf.com  12002990505820781658   434251870533705029
31  d-02.winudf.com  12169615549004988701   166625043184207043
32  d-03.winudf.com  12454832026850195165   285216477845206464
33  d-05.winudf.com  13150121062688234526   695289035838039361
34  d-01.winudf.com  13184936874599904655    34815811911670129
35  d-02.winudf.com  13371020549017399961   186083674417495306
36  d-05.winudf.com  13378005536304911769     6984987287511808
37  d-05.winudf.com  13773539064902090035   395533528597178266
38  d-02.winudf.com  14336560970540577641   563021905638487606
39  d-03.winudf.com  14344554222429636802     7993251889059161
40  d-03.winudf.com  14469340804132123322   124786581702486520
41  d-03.winudf.com  15325594361307077113   856253557174953791
42  d-05.winudf.com  15948193272562514287   622598911255437174
43  d-02.winudf.com  16317840089229516113   369646816667001826
44  d-04.winudf.com  16549567120859172415   231727031629656302
45  d-04.winudf.com  17365357814277938146   815790693418765731
46  d-04.winudf.com  17481834308909352631   116476494631414485
47  d-03.winudf.com  17720137207200896767   238302898291544136
48  d-02.winudf.com  18280333195893202206   560195988692305439
49  d-04.winudf.com  18335112364259407429    54779168366205223
d-02.winudf.com 3450682849988393971
d-05.winudf.com 3001473103795785790
d-03.winudf.com 3002757062207650619
d-01.winudf.com 6276913657130711413
d-04.winudf.com 2603285691136865636
```
